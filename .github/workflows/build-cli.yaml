name: Build CLI for Keyscope

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch: # Allows manual trigger for CLI only

permissions:
  contents: write

jobs:
  build-cli:
    name: CLI Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: macos
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install Dependencies
        run: dart pub get

      - name: Build CLI Bundle
        shell: bash
        run: |
          # Build with native assets (e.g. objective_c)
          dart build cli --target=bin/keyscope.dart -o dist/keyscope

      - name: Zip Bundle (Unix/Linux)
        if: matrix.platform != 'windows'
        run: |
          cd dist
          zip -r ../keyscope-cli-${{ matrix.platform }}-${{ matrix.arch }}.zip keyscope/

      - name: Zip Bundle (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          cd dist
          Compress-Archive -Path keyscope -DestinationPath ..\keyscope-cli-${{ matrix.platform }}-${{ matrix.arch }}.zip

      - name: Release / Upload
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: keyscope-cli-${{ matrix.platform }}-${{ matrix.arch }}.zip
          draft: true
          # This action is smart: it appends to the release if it exists.