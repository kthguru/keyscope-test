name: Build GUI for Keyscope

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch: # Allows manual trigger for GUI only

permissions:
  contents: write

jobs:
  build-gui:
    name: GUI Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: macos
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # Dependency Steps (OS Specific)
      # ----------------------------------------------------------------
      - name: Install Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      # ----------------------------------------------------------------
      # Build Steps (OS Specific)
      # ----------------------------------------------------------------
      - name: Build macOS App
        if: matrix.platform == 'macos'
        run: flutter build macos --release

      - name: Build Linux App
        if: matrix.platform == 'linux'
        run: flutter build linux --release

      - name: Build Windows App
        if: matrix.platform == 'windows'
        run: flutter build windows --release

      # ----------------------------------------------------------------
      # Archive Steps (OS Specific Paths)
      # ----------------------------------------------------------------
      - name: Archive macOS App
        if: matrix.platform == 'macos'
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../keyscope-gui-${{ matrix.platform }}-${{ matrix.arch }}.zip Keyscope.app/

      - name: Archive Linux
        if: matrix.platform == 'linux'
        run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../keyscope-gui-${{ matrix.platform }}-${{ matrix.arch }}.zip .

      - name: Archive Windows
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          cd build\windows\x64\runner\release
          Compress-Archive -Path * -DestinationPath ..\..\..\..\..\keyscope-gui-${{ matrix.platform }}-${{ matrix.arch }}.zip

      # ----------------------------------------------------------------
      # Upload
      # ----------------------------------------------------------------
      - name: Release / Upload
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: keyscope-gui-${{ matrix.platform }}-${{ matrix.arch }}.zip
          draft: true
